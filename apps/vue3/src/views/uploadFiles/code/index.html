<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大文件批量上传示例</title>
    <style>
        .file-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .progress {
            height: 10px;
            background: #eee;
            margin: 10px 0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
        }

        button {
            margin-right: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <input type="file" id="fileInput" multiple accept="*/*">
    <div id="fileList"></div>

    <script>
        // 配置参数
        const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB 切片大小
        const MAX_WORKERS = 4; // 最大Web Worker数量

        // 全局状态管理
        const uploadManager = {
            files: [], // 所有文件信息
            workers: [], // 活跃的worker
            taskQueue: [], // 等待队列
            fileId: 0 // 文件唯一标识
        };

        // 初始化文件选择
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        // 处理文件选择
        function handleFileSelect(e) {
            const files = e.target.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                const fileInfo = {
                    id: `file-${uploadManager.fileId++}`,
                    name: file.name,
                    size: file.size,
                    file: file,
                    status: 'pending', // pending, uploading, paused, completed, error
                    progress: 0,
                    chunks: [], // 切片信息
                    completedChunks: 0, // 已完成切片数
                    totalChunks: 0, // 总切片数
                    worker: null // 当前处理的worker
                };

                uploadManager.files.push(fileInfo);
                renderFileItem(fileInfo);
                addToTaskQueue(fileInfo.id);
            });

            processTaskQueue();
        }

        // 添加到任务队列
        function addToTaskQueue(fileId) {
            uploadManager.taskQueue.push(fileId);
        }

        // 处理任务队列
        function processTaskQueue() {
            // 如果worker数量未满且有等待任务
            while (uploadManager.workers.length < MAX_WORKERS && uploadManager.taskQueue.length > 0) {
                const fileId = uploadManager.taskQueue.shift();
                const fileInfo = uploadManager.files.find(f => f.id === fileId);
                if (fileInfo && fileInfo.status === 'pending') {
                    startUpload(fileInfo);
                }
            }
        }

        // 开始上传
        function startUpload(fileInfo) {
            // 创建新的worker
            const worker = new Worker('upload-worker.js');
            fileInfo.worker = worker;
            fileInfo.status = 'uploading';
            uploadManager.workers.push(worker);

            // 计算总切片数
            fileInfo.totalChunks = Math.ceil(fileInfo.size / CHUNK_SIZE);
            updateFileStatus(fileInfo.id);

            // 向worker发送初始信息
            worker.postMessage({
                type: 'init',
                file: fileInfo.file,
                fileId: fileInfo.id,
                chunkSize: CHUNK_SIZE,
                totalChunks: fileInfo.totalChunks
            });

            // 监听worker消息
            worker.onmessage = function (e) {
                const { type, data } = e.data;

                switch (type) {
                    case 'chunkProcessed':
                        // 处理完一个切片，准备上传
                        uploadChunk(fileInfo, data.chunkIndex, data.chunk, data.hash);
                        break;

                    case 'uploadProgress':
                        // 更新整体进度
                        fileInfo.completedChunks++;
                        fileInfo.progress = (fileInfo.completedChunks / fileInfo.totalChunks) * 100;
                        updateFileStatus(fileInfo.id);
                        break;

                    case 'completed':
                        // 上传完成
                        completeUpload(fileInfo.id);
                        break;

                    case 'error':
                        // 错误处理
                        fileInfo.status = 'error';
                        updateFileStatus(fileInfo.id);
                        releaseWorker(worker, fileInfo.id);
                        break;
                }
            };

            // 监听worker错误
            worker.onerror = function (error) {
                console.error(`Worker error: ${error.message}`);
                fileInfo.status = 'error';
                updateFileStatus(fileInfo.id);
                releaseWorker(worker, fileInfo.id);
            };
        }

        // 上传切片
        function uploadChunk(fileInfo, chunkIndex, chunk, hash) {
            // 这里使用模拟上传，实际项目中替换为真实的API请求
            setTimeout(() => {
                // 模拟上传成功
                fileInfo.worker.postMessage({
                    type: 'chunkUploaded',
                    chunkIndex: chunkIndex
                });
            }, 100); // 模拟网络延迟
        }

        // 完成上传
        function completeUpload(fileId) {
            const fileInfo = uploadManager.files.find(f => f.id === fileId);
            if (fileInfo) {
                fileInfo.status = 'completed';
                fileInfo.progress = 100;
                updateFileStatus(fileId);
                releaseWorker(fileInfo.worker, fileId);
            }
        }

        // 暂停上传
        function pauseUpload(fileId) {
            const fileInfo = uploadManager.files.find(f => f.id === fileId);
            if (fileInfo && fileInfo.status === 'uploading' && fileInfo.worker) {
                fileInfo.worker.postMessage({ type: 'pause' });
                fileInfo.status = 'paused';
                releaseWorker(fileInfo.worker, fileId);
                updateFileStatus(fileId);
                processTaskQueue(); // 处理队列中的下一个任务
            }
        }

        // 恢复上传
        function resumeUpload(fileId) {
            const fileInfo = uploadManager.files.find(f => f.id === fileId);
            if (fileInfo && fileInfo.status === 'paused') {
                fileInfo.status = 'pending';
                addToTaskQueue(fileId);
                processTaskQueue();
            }
        }

        // 释放worker资源
        function releaseWorker(worker, fileId) {
            // 从活跃worker列表中移除
            uploadManager.workers = uploadManager.workers.filter(w => w !== worker);

            // 终止worker
            worker.terminate();

            // 更新文件信息
            const fileInfo = uploadManager.files.find(f => f.id === fileId);
            if (fileInfo) {
                fileInfo.worker = null;
            }
        }

        // 渲染文件项
        function renderFileItem(fileInfo) {
            const fileList = document.getElementById('fileList');
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.id = `item-${fileInfo.id}`;

            fileItem.innerHTML = `
                <div>${fileInfo.name} (${formatSize(fileInfo.size)})</div>
                <div class="progress">
                    <div class="progress-bar" id="progress-${fileInfo.id}" style="width: 0%"></div>
                </div>
                <div>
                    <span id="status-${fileInfo.id}">等待上传</span>
                    <button onclick="pauseUpload('${fileInfo.id}')" id="pause-${fileInfo.id}">暂停</button>
                    <button onclick="resumeUpload('${fileInfo.id}')" id="resume-${fileInfo.id}" disabled>恢复</button>
                </div>
            `;

            fileList.appendChild(fileItem);
        }

        // 更新文件状态
        function updateFileStatus(fileId) {
            const fileInfo = uploadManager.files.find(f => f.id === fileId);
            if (!fileInfo) return;

            // 更新进度条
            document.getElementById(`progress-${fileId}`).style.width = `${fileInfo.progress}%`;

            // 更新状态文本
            const statusText = {
                'pending': '等待上传',
                'uploading': `上传中 (${Math.round(fileInfo.progress)}%)`,
                'paused': `已暂停 (${Math.round(fileInfo.progress)}%)`,
                'completed': '上传完成',
                'error': '上传失败'
            }[fileInfo.status];

            document.getElementById(`status-${fileId}`).textContent = statusText;

            // 更新按钮状态
            document.getElementById(`pause-${fileId}`).disabled =
                fileInfo.status !== 'uploading';
            document.getElementById(`resume-${fileId}`).disabled =
                fileInfo.status !== 'paused';
        }

        // 格式化文件大小
        function formatSize(bytes) {
            if (bytes < 1024) return `${bytes} B`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
            return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
        }

        // 暴露函数到全局，供按钮调用
        window.pauseUpload = pauseUpload;
        window.resumeUpload = resumeUpload;
    </script>
</body>

</html>